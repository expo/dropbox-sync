{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["var _ = require('lodash-node');\nvar delayAsync = require('delay-async');\nvar dropbox = require('dropbox');\nvar events = require('events');\nvar fs = require('fs');\nvar mkdirp = require('mkdirp');\nvar path = require('path');\nvar secret = require('@exponent/secret');\n\nfunction getClient() {\n  return new dropbox.Client({\n    token: secret.dropbox._ccheeverTestAccessToken,\n    key: secret.dropbox.appKey,\n    secret: secret.dropbox.appSecret,\n  });\n}\n\nasync function syncLoop(client, cursor, destFolder, opts) {\n\n  opts = opts || {};\n  await mkdirp.promise(destFolder);\n  var newCursor = await getAsync(client, cursor, destFolder, opts);\n  var result;\n  do {\n    if (opts.verbose) {\n      console.log(\"Polling for changes...\");\n    }\n    result = await client.promise.pollForChanges(newCursor);\n    if (!result) {\n      if (opts.verbose) {\n        console.error(\"Failure! No response from `pollForChanges`\");\n      }\n      // TODO: Implement a smart back-off strategy\n      result = {hasChanges: false, retryAfter: 30000};\n    }\n    if (!result.hasChanges && result.retryAfter) {\n      await delayAsync(result.retryAfter * 1000);\n    }\n  } while (!result.hasChanges);\n\n  return syncLoop(client, newCursor, destFolder, opts);\n\n}\n\n\nasync function getAsync(client, cursor, destFolder, opts) {\n\n  var delta = await client.promise.delta(cursor);\n  if (!delta) {\n    return cursor;\n  }\n  var newCursor = delta.cursorTag;\n  var awaitables = [];\n  for (var change of delta.changes) {\n    awaitables.push(processChangeAsync(client, change, destFolder, opts));\n  }\n  await Promise.all(awaitables);\n\n  return newCursor;\n\n}\n\nasync function processChangeAsync(client, change, destFolder, opts) {\n  opts = opts || {};\n  var dest = path.join(destFolder, change.path);\n  if (opts.verbose) {\n    console.log(\"Syncing\", dest, \"...\");\n  }\n  if (change.wasRemoved) {\n    await fs.promise.unlink(change.path);\n  } else if (change.stat.isFolder) {\n    await mkdirp.promise(dest);\n  } else if (change.stat.isFile) {\n    // nesh*> yield fs.promise.writeFile('/tmp/image.jpg', yield c.promise.readFile('/dellie.jpg', {buffer:true}))\n    var contentsBuffer = await client.promise.readFile(change.path, {buffer: true});\n    await fs.promise.writeFile(dest, contentsBuffer);\n  } else {\n    throw new Error(\"I'm confused and don't know how to deal with this change\", change);\n  }\n}\n\n\n\nmodule.exports = {\n  getAsync,\n  getClient,\n  processChangeAsync,\n  secret,\n  syncLoop,\n};\n"],"sourceRoot":"/source/"}