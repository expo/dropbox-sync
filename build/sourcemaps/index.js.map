{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["var _ = require('lodash-node');\nvar delayAsync = require('delay-async');\nvar dropbox = require('dropbox');\nvar events = require('events');\nvar fs = require('fs');\nvar moment = require('moment-timezone');\nvar mkdirp = require('mkdirp');\nvar path = require('path');\nvar secret = require('@exponent/secret');\n\nfunction getClient() {\n  return new dropbox.Client({\n    token: secret.dropbox._ccheeverTestAccessToken,\n    key: secret.dropbox.appKey,\n    secret: secret.dropbox.appSecret,\n  });\n}\n\nfunction startSyncing(client, destFolder, opts) {\n  opts = opts || {};\n  var cursor = opts.cursor || null;\n  delete opts.cursor;\n  if (opts.verbose) {\n    console.log(\"Created destination folder\", destFolder);\n  }\n\n  var emitter = new events.EventEmitter();\n  emitter._flags = {};\n  emitter.stopSyncingAsync = function () {\n    emitter._flags.stop = true;\n    return new Promise((fulfill, reject) => {\n      emitter.on('stopped', fulfill);\n    });\n  }\n\n  syncLoop(client, cursor, destFolder, emitter, opts, emitter._flags).then(console.log, console.error);\n\n  return emitter;\n\n}\n\nasync function syncLoop(client, cursor, destFolder, emitter, opts, flags) {\n\n  opts = opts || {};\n  await mkdirp.promise(destFolder);\n  if (flags.stop) {\n    emitter.emit('stopped', cursor);\n    return;\n  }\n  var newCursor = await getAsync(client, cursor, destFolder, emitter, opts);\n  if (flags.stop) {\n    emitter.emit('stopped', cursor);\n    return;\n  }\n  var result;\n  do {\n    if (opts.verbose) {\n      console.log(\"Polling for changes...\");\n    }\n    result = await client.promise.pollForChanges(newCursor);\n    if (opts.verbose) {\n      console.log(\"Polled successfuly\");\n    }\n    if (flags.stop) {\n      emitter.emit('stopped', cursor);\n      return;\n    }\n    if (!result) {\n      console.error(\"Failure! No response from `pollForChanges`\");\n      // TODO: Implement a smart back-off strategy\n      result = {hasChanges: false, retryAfter: 30000};\n    }\n    if (!result.hasChanges && result.retryAfter) {\n      await delayAsync(result.retryAfter * 1000);\n      if (flags.stop) {\n        return;\n      }\n    }\n  } while (!result.hasChanges && !flags.stop);\n\n\n  if (flags.stop) {\n    emitter.emit('stopped', cursor);\n    return;\n  }\n  return syncLoop(client, newCursor, destFolder, emitter, opts, flags);\n\n}\n\n\nasync function getAsync(client, cursor, destFolder, emitter, opts) {\n\n  var delta = await client.promise.delta(cursor);\n  if (!delta) {\n    return cursor;\n  }\n  var newCursor = delta.cursorTag;\n  var awaitables = [];\n  for (var change of delta.changes) {\n    emitter.emit('changeTo', change.path, change);\n    awaitables.push(processChangeAsync(client, change, destFolder, emitter, opts));\n  }\n  try {\n    await Promise.all(awaitables);\n  } catch (e) {\n    console.error(\"Error syncing (but will continue anyway):\", e.message);\n    emitter.emit('errorIgnored', e);\n    // Wait 15 seconds\n    await delayAsync(15000);\n    // Return the old cursor since the sync failed\n    return cursor;\n  }\n\n  //console.log(\"Synced as of\", Date.now());\n  emitter.emit('syncedToCursor', newCursor);\n  return newCursor;\n\n}\n\nasync function processChangeAsync(client, change, destFolder, emitter, opts) {\n  opts = opts || {};\n  var dest = path.join(destFolder, change.path);\n  if (opts.verbose) {\n    console.log(\"Syncing\", dest, \"...\");\n  }\n  if (change.wasRemoved) {\n    await fs.promise.unlink(dest);\n    emitter.emit('didRemove', dest, change);\n  } else if (change.stat.isFolder) {\n    await mkdirp.promise(dest);\n    emitter.emit('didMkdirp', dest, change);\n  } else if (change.stat.isFile) {\n    // nesh*> yield fs.promise.writeFile('/tmp/image.jpg', yield c.promise.readFile('/dellie.jpg', {buffer:true}))\n    var contentsBuffer = await client.promise.readFile(change.path, {buffer: true});\n    await fs.promise.writeFile(dest, contentsBuffer);\n    emitter.emit('didWriteFile', dest, change);\n  } else {\n    throw new Error(\"I'm confused and don't know how to deal with this change\", change);\n  }\n}\n\n\n\nmodule.exports = {\n  getAsync,\n  getClient,\n  processChangeAsync,\n  secret,\n  syncLoop,\n  startSyncing,\n  c: getClient(),\n};\n"],"sourceRoot":"/source/"}