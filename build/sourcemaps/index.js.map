{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["var _ = require('lodash-node');\nvar delayAsync = require('delay-async');\nvar dropbox = require('dropbox');\nvar events = require('events');\nvar fs = require('fs');\nvar moment = require('moment-timezone');\nvar mkdirp = require('mkdirp');\nvar path = require('path');\nvar secret = require('@exponent/secret');\n\nfunction getClient() {\n  return new dropbox.Client({\n    token: secret.dropbox._ccheeverTestAccessToken,\n    key: secret.dropbox.appKey,\n    secret: secret.dropbox.appSecret,\n  });\n}\n\nclass DropboxSyncer extends events.EventEmitter {\n  constructor(client, destFolder, opts) {\n\n    super();\n    this.client = client || getClient();\n    this.destFolder = destFolder;\n    this.opts = opts = opts || {};\n    this.state = 'stopped';\n\n    this.cursor = opts.cursor || null;\n    this.emitter = opts.emitter || this;\n    this._shouldStop = false;\n    this.logger = opts.logger || console || {\n      log: () => undefined,\n      error: () => undefined,\n      warn: () => undefined,\n    };\n\n  }\n\n  startSyncing() {\n    this._shouldStop = false;\n    this.state = 'syncing';\n    this._syncLoopAsync().then((result) => {\n      if (result != null) {\n        this.logger.log(result);\n      }\n    }).catch((err) => {\n      if (this.opts.logger) {\n        this.logger.error(err, err.stack);\n      } else {\n        console.error(err, err.stack);\n      }\n    });\n    return this;\n  }\n\n  stopSyncingAsync() {\n    this._shouldStop = true;\n    return new Promise((fulfill, reject) => {\n      this.emitter.on('stopped', fulfill);\n    });\n  }\n\n  _stop() {\n    this.state = 'stopped';\n    this.emitter.emit('stopped', this.cursor);\n    return this.cursor;\n  }\n\n  async _syncLoopAsync() {\n\n    await mkdirp.promise(this.destFolder);\n\n    if (this._shouldStop) { return this._stop(); }\n\n    var newCursor = await this.syncAsync();\n\n    if (this._shouldStop) { return this._stop(); }\n\n    var result;\n    do {\n      this.logger.log(\"Polling for changes...\");\n\n      result = await this.client.promise.pollForChanges(newCursor);\n\n      this.logger.log(\"Polled successfully\");\n\n      if (this._shouldStop) { return this._stop(); }\n\n      if (!result) {\n        // Not sure what to do here, so we'll just back off and try again in a bit\n        this.logger.error(\"No response from polling; will retry\");\n\n        result = {hasChanges: false, retryAfter: 2000};\n      }\n\n      if (!result.hasChanges && result.retryAfter) {\n        await delayAsync(result.retryAfter * 1000);\n      }\n\n    } while (!result.hasChanges && !this._shouldStop);\n\n    if (this._shouldStop) { return this._stop(); }\n\n    return this._syncLoopAsync();\n  }\n\n  _\n\n  async syncAsync() {\n    var delta = await this.client.promise.delta(this.cursor);\n\n    if (!delta) {\n      return this.cursor;\n    }\n\n    var newCursor = delta.cursorTag;\n\n    var awaitables = [];\n    for (var change of delta.changes) {\n      this.emitter.emit('changeTo', change.path, change);\n      awaitables.push(this.processChangeAsync(change));\n    }\n\n    try {\n      await Promise.all(awaitables);\n    } catch (e) {\n      this.logger.error(\"Error syncing (but will keep trying):\", e.message);\n      this.emitter.emit('errorIgnored', e);\n      // TODO: Implement some kind of smart backoff\n      await delayAsync(2000);\n      return this.cursor;\n    }\n\n    // Update cursor to the new value since we've successfully updated\n    this.cursor = newCursor;\n    this.logger.log(\"New cursor is now\", this.cursor);\n    this.emitter.emit('syncedToCursor', this.cursor);\n    return this.cursor;\n\n  }\n\n  async processChangeAsync(change) {\n    var dest = path.join(this.destFolder, change.path);\n    this.logger.log(\"Syncing to\", dest, \"...\");\n    if (change.wasRemoved) {\n\n    } else if (change.stat.isFolder) {\n\n      if (change.wasRemoved) {\n        await fs.promise.rmdir(dest);\n        this.emitter.emit('didRemove', dest, change);\n      } else {\n        await mkdirp.promise(dest);\n        if (this.opts.logger) { this.opts.logger.log(\"Updating folder at\", dest); }\n        this.emitter.emit('didMkdirp', dest, change);\n      }\n\n    } else if (change.stat.isFile) {\n      if (change.wasRemoved) {\n        try {\n          await fs.promise.unlink(dest);\n        } catch (e) {\n          if (e.message && e.message.match(/ENOENT:/)) {\n            this.logger.error(\"Trying to remove file that's already gone, ignoring:\", dest);\n            this.emitter.emit('errorIgnored', e);\n          } else {\n            throw e;\n          }\n        }\n        this.emitter.emit('didRemove', dest, change);\n        this.logger.log(\"Removed\", dest);\n      } else {\n        var contentsBuffer = await this.client.promise.readFile(change.path, {buffer: true});\n        await fs.promise.writeFile(dest, contentsBuffer);\n        this.emitter.emit('didWriteFile', dest, change);\n      }\n    } else {\n      var err = new Error(\"I'm confused; I don't know how to deal with this kind of change\");\n      err.change = change;\n      this.emitter.emit('errorConfused', err);\n      throw err;\n    }\n\n    return true;\n\n  }\n}\n\nmodule.exports = function (...args) {\n  return new DropboxSyncer(...args);\n};\n\n_.assign(module.exports, {\n  DropboxSyncer,\n  getClient,\n  c: getClient(),\n});\n"],"sourceRoot":"/source/"}